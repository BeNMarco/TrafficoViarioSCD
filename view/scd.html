<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Space</title>
	<link rel="stylesheet" href="style.css">
	<link rel="stylesheet" href="js/utils/jquery-ui.theme.min.css">
	<script type="text/javascript" src="js/paper-full.js"></script>
	<script type="text/javascript" src="js/quartiere1.js"></script>
	<script type="text/javascript" src="js/quartiere2_updated.js"></script>
	<script type="text/javascript" src="js/quartiere3.js"></script>
	<script type="text/javascript" src="js/map.js"></script>
	<script type="text/javascript" src="js/entities.js"></script>
	<script type="text/javascript" src="js/utils/jquery.min.js"></script>
	<script type="text/javascript" src="js/utils/jquery-ui.min.js"></script>
	<script type="text/javascript" src="js/utils/jquery.mousewheel.min.js"></script>
	<script type="text/javascript">
		myMap = new Map();
		mapLayer = null;
		test = quartiere1;
		paper.install(window);

		var style = new MapStyle();
			style.laneWidth = 7;
			style.pavementWidth = 3;
			style.lineWidth = 0.3;
			style.debug = true;

		var dDialog = null;
		var quartieri = null;
		function traslladar(a,b){
			var center = paper.project.view.center;
			var desX = (a.x - b.x);
			var desY=  (a.y - b.y);

			var newCenter = [center.x + desX , center.y + desY];
			return newCenter;
		}

		function zoomIn(){
			view.zoom = view.zoom*1.1;
		}

		function zoomOut(){
			view.zoom = view.zoom/1.1;
		}

		function switchTrafficLights(){
			myMap.switchTrafficLights();
		}

		onload = function(e){
			loadingDialog = $('#loadingDialog').dialog({dialogClass:'no-close'});

			quartieri = {
				quartiere1: quartiere1,
				quartiere2: quartiere2,
				quartiere3: quartiere3,
			}
			paper.setup("canvas");

			myMap.load(test);
			myMap.setStyle(style);
			myMap.draw();
			mapLayer = project.activeLayer;
			//secondLayer = new Layer();
			view.draw();

			/*
			var entStyle = new EntitiesStyle();

			entStyle.carShape.args.size = [5,8];
			var carOne = new Car();
			carOne.draw(entStyle);
			carOne.hide();
			var newPos = myMap.streets[23].getPositionAt(50, true, 0);
			carOne.move(newPos.position, newPos.angle);
			carOne.show();
			*/
			
			var myTool = new Tool();
        	myTool.onMouseDown = function(event) {
				path = new Point();
				path.add(event.point);
			};

			myTool.onMouseDrag=function(event) {
				
	            path.add(event.point);
				 
				var des = traslladar (event.downPoint ,event.point); 
				paper.project.view.center = des; 
				
			}

			$('#canvas').mousewheel(function(event){
				event.deltaY > 0 ? zoomIn() : zoomOut();
			});

			$('#dataDialog').dialog({autoOpen: false, resizable: false, width: 800, height: 600});

			$('#getData').on('click', function(){
				$('#dataDialog p').text(JSON.stringify(myMap.getUpdatedData(), null, '\t'));
				$('#dataDialog').dialog("open");
			});
			$("#mapSelector").on('change', function(){
				console.log("selezionato "+this.value);
				project.clear();
				myMap.load(quartieri[this.value]);
				myMap.setStyle(style);
				myMap.draw();
			});
			
			myMap.onStartLoading(function() {
				loadingDialog.dialog("open");
				$('#outputData').text("Started loading and drawing");
			});

			myMap.onFinishDrawing(function() {
				loadingDialog.dialog("close");
				$('#outputData').text("Map ready");
			});
		}

	</script>

</head>
<body>
	
<!--
	<p>
		<a id="openws" href="#" onClick="openSocket()">Open</a>
		<a id="closews" href="#" onClick="closeSocket()">Close</a>
	</p>-->
	
	<div id="canvas-wrap">
		<div id="dataDialog" style="overflow:auto;">
			<p style="font-size:10pt;"></p>
		</div>
		<div id="loadingDialog">
			<p>Please wait!<br />Loading and drawing the map</p>
		</div>
		
		<form>
		<label for="mapSelector">Seleziona il quartiere</label>
		<select id="mapSelector">
			<option value="quartiere1">Quartiere 1</option>
			<option value="quartiere2">Quartiere 2</option>
			<option value="quartiere3">Quartiere 3</option>
		</select>
		<span id="debug"><a id="getData" href="#">Get data</a> - </span>
		<span id="debugOutput"></span>
		</form>
		<canvas id="canvas" resize hidpi="off" style="background-color:#F0EDE5;"></canvas>
		<div id="zoom-controls-div">
			<p><a id="zoomInBtn" href="#" onClick="zoomIn()">+</a> <a id="zoomOutBtn" href="#" onClick="zoomOut()">-</a></p>
			<p><a onClick="switchTrafficLights()">Switch</a></p>
		</div>
		<div></div>
	</div>
</body>
</html>
